<div class="orders-container">
  <div class="orders-card">

    <!-- TOP BAR -->
    <div class="orders-top-bar">
      <h2 class="page-title">Orders</h2>

      <input
        type="text"
        class="search-box"
        placeholder="Search customer..."
        [(ngModel)]="searchText"
        (input)="applyFilter()"
      />

      <button class="btn add" (click)="goToAddOrder()">+ Add Order</button>
    </div>

    <!-- TABLE -->
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Customer Name</th>
            <th>Order Date & Time</th>
            <th>Status</th>
            <th>Action</th>
            <th>View</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let order of paginatedOrders; trackBy: trackById">
            <td>{{ order.id }}</td>
            <td>{{ order.customerName }}</td>
            <td>{{ order.orderDate }}</td>
            <td>{{ order.status }}</td>
            <td>
              <button class="btn delete" (click)="confirmDelete(order)">Delete</button>
            </td>
            <td>
              <button class="btn view" (click)="viewOrder(order)">View</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>
</div>

<!-- ================= ADD ORDER MODAL ================= -->
<div class="view-overlay" *ngIf="showAddOrderModal">
  <div class="view-card">

    <div class="view-header">
      <h3>Add Order</h3>
      <button class="close-btn" (click)="closeAddOrderModal()">✖</button>
    </div>

    <div class="view-body">

      <!-- CUSTOMER -->
      <input
        type="text"
        class="search-box"
        placeholder="Enter customer mobile number"
        [(ngModel)]="customerMobile"
        (keyup)="onMobileChange()"
      />

      <input
        type="text"
        class="search-box"
        placeholder="Customer name"
        [(ngModel)]="customerName"
        disabled
      />

      <!-- ITEMS -->
      <button class="btn add" style="margin-top:10px" (click)="addItemRow()">+ Add Item</button>

      <div *ngIf="showItemSection">
        <div class="item-card" *ngFor="let item of orderItems; trackBy: trackById">

          <select class="search-box" [(ngModel)]="item.product_id" (change)="onProductSelect(item)">
            <option value="">Select Product</option>
            <option *ngFor="let p of products" [value]="p.id">
              {{ p.name }}
            </option>
          </select>

          <div class="row">
            <input
              type="number"
              min="1"
              class="qty-box"
              [(ngModel)]="item.qty"
              (input)="onQtyChange(item)"
              placeholder="Qty"
            />
            <span class="price">₹{{ item.price }}</span>
          </div>

          <div class="meta">
            Earn: {{ item.earn_beans }}% | Redeem: {{ item.redeem_beans }}%
          </div>

          <div class="item-total">Item Total: ₹{{ item.total }}</div>
        </div>
      </div>

      <!-- TOTALS -->
      <div class="totals" *ngIf="orderItems.length">
        <p><strong>Total Amount:</strong> ₹{{ grandTotal }}</p>
        <p><strong>Earn Beans:</strong> {{ totalEarnBeans }}</p>
        <p><strong>Redeem Beans:</strong> {{ totalRedeemBeans }}</p>
      </div>

      <!-- PAYMENT (INSIDE MODAL) -->
      <div class="payment-box" *ngIf="orderItems.length">

        <strong>Payment Type</strong>
        <div class="payment-row">
          <label><input type="radio" value="FULL" [(ngModel)]="paymentType"> Full</label>
          <label><input type="radio" value="PARTIAL" [(ngModel)]="paymentType"> Partial</label>
        </div>

        <input
          *ngIf="paymentType === 'PARTIAL'"
          type="number"
          class="amount-input"
          placeholder="Enter paid amount"
          [(ngModel)]="paidAmount"
        />

        <strong style="margin-top:10px;display:block">Payment Mode</strong>
        <div class="payment-row">
          <label><input type="radio" value="CASH" [(ngModel)]="paymentMode"> Cash</label>
          <label><input type="radio" value="ONLINE" [(ngModel)]="paymentMode"> Online</label>
        </div>

      </div>

    </div>

    <!-- FOOTER -->
    <div class="view-footer">
      <button class="btn add" (click)="saveOrder()">Save Order</button>
      <button class="btn edit" (click)="closeAddOrderModal()">Cancel</button>
    </div>

  </div>
</div>

<!-- ================= QR PAGE ================= -->
<div class="qr-overlay" *ngIf="showQRPage">
  <div class="qr-card">
    <h3>Scan & Pay</h3>
    <p><strong>{{ customerName }}</strong></p>
    <p>{{ customerMobile }}</p>

    <div class="qr-box">QR</div>

    <p><strong>Amount:</strong> ₹{{ payableAmount }}</p>
    <p class="timer">Time Left: {{ qrTimer }}s</p>

    <button class="btn delete" (click)="cancelQR()">Cancel</button>
    <button class="btn view" (click)="paymentDone()">Payment Done</button>
  </div>
</div>

<!-- ================= PRINT ================= -->
<div class="print-overlay" *ngIf="showPrint">
  <div class="print-bill">
    <h4>COFFEE HOUSE</h4>
    <p>{{ customerName }}</p>
    <p>{{ customerMobile }}</p>
    <hr>

    <div *ngFor="let item of orderItems">
      {{ item.name }} x{{ item.qty }}<br>
      ₹{{ item.total }}
    </div>

    <hr>
    <strong>Total: ₹{{ payableAmount }}</strong>
    <p>{{ today | date:'short' }}</p>

    <button class="btn view" (click)="printBill()">Print</button>
  </div>
</div>
